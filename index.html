<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#0f172a"/>
<link rel="manifest" href="manifest.webmanifest"/>
<title>Генератор</title>
<style>
:root{--bg:#f6f9ff;--bg2:#eef2ff;--fg:#0f172a;--muted:#64748b;--card:#fff;--br:#e2e8f0;--acc:#0f172a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;color:var(--fg);
background:radial-gradient(1200px 500px at 0% -10%,var(--bg2),transparent 60%),linear-gradient(180deg,var(--bg),#fff 60%)}
.wrap{max-width:100%;margin:0 auto;padding:12px}
.topbar{display:flex;gap:10px;align-items:center;margin:6px 2px 10px}
.logo{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#0f172a;color:#fff;font-weight:800;font-size:14px;letter-spacing:1px}
.chip{padding:4px 8px;border:1px solid var(--br);border-radius:999px;font-size:12px;color:var(--muted)}
fieldset{border:1px solid var(--br);border-radius:12px;padding:6px 10px;background:var(--card);width:fit-content}
legend{font-size:12px;color:var(--muted);padding:0 6px}
.tight{display:inline-flex;align-items:center;gap:10px;min-width:0}
.controls{display:flex;align-items:center;gap:10px;flex-wrap:nowrap}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
.row + .row{margin-top:10px}
.age-grid{display:grid;grid-template-columns:repeat(7,minmax(28px,1fr));gap:6px}
label.inline{display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 6px 24px rgba(2,6,23,.06)}
thead{background:#f1f5f9;color:#475569;font-size:14px}
th,td{padding:10px 12px;border-top:1px solid var(--br)}
thead th:nth-child(2), thead th:nth-child(3), thead th:nth-child(4),
tbody td:nth-child(3), tbody td:nth-child(4),
tfoot td:nth-child(2), tfoot td:nth-child(3){text-align:center}
tfoot td{background:#f8fafc;font-weight:600}
.idcell{width:54px;text-align:center}
.idpill{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:999px;background:#0f172a;color:#fff;font-weight:800;margin:auto}
.btn{appearance:none;border:1px solid var(--br);background:#fff;padding:14px 16px;border-radius:12px;cursor:pointer;font-weight:800;width:100%}
.btn.primary{background:var(--acc);color:#fff;border-color:#0b1220}
.btn:disabled{opacity:.5;cursor:not-allowed}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
@media (max-width:520px){.actions{grid-template-columns:1fr}}
.muted{color:var(--muted)}
.loading{padding:8px 10px;border:1px dashed var(--br);border-radius:10px;background:#fff;margin-top:10px}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:12px;z-index:100}
.modal{background:#fff;border-radius:16px;max-width:640px;width:100%;padding:14px}
.cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.card{border:1px solid var(--br);border-radius:12px;padding:12px;cursor:pointer;box-shadow:0 2px 10px rgba(2,6,23,.04);user-select:none}
.card.sel{background:#ecfdf5;border-color:#34d399}
.topbar2{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.hidden{display:none}
.warn{padding:10px 12px;border:1px solid #f59e0b;background:#fff7ed;color:#92400e;border-radius:10px;margin-top:10px}
.small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="logo">NG</div>
    <div class="chip">Генератор оцінки · r28</div>
    <div id="dataState" class="chip">Завантаження…</div>
  </div>

  <div class="row">
    <fieldset class="tight">
      <legend>Категорія</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="cat" value="2" checked><span>2</span></label>
        <label class="inline"><input type="radio" name="cat" value="3"><span>3</span></label>
      </div>
    </fieldset>
    <fieldset class="tight">
      <legend>Стать</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="sex" value="M" checked><span>М</span></label>
        <label class="inline"><input type="radio" name="sex" value="J"><span>Ж</span></label>
      </div>
    </fieldset>
  </div>

  <div class="row" style="flex-direction:column">
    <fieldset>
      <legend>Вікова група (1–7)</legend>
      <div class="age-grid" id="ageGrid"></div>
    </fieldset>
    <fieldset style="margin-top:10px">
      <legend>Оцінка</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="grade" value="2"><span>2</span></label>
        <label class="inline"><input type="radio" name="grade" value="3" checked><span>3</span></label>
        <label class="inline"><input type="radio" name="grade" value="4"><span>4</span></label>
        <label class="inline"><input type="radio" name="grade" value="5"><span>5</span></label>
      </div>
    </fieldset>
  </div>

  <div style="margin-top:12px">
    <table>
      <thead><tr><th style="width:54px">№</th><th>Вправа</th><th>Результат</th><th style="width:120px">Бал</th></tr></thead>
      <tbody id="tbody">
        <tr><td class="idcell"><span class="idpill">—</span></td><td>Метання медболу</td><td>—</td><td>—</td></tr>
        <tr><td class="idcell"><span class="idpill">2/14</span></td><td>Підтягування / КСВ</td><td>—</td><td>—</td></tr>
        <tr><td class="idcell"><span class="idpill">—</span></td><td>Функц. витривалість</td><td>—</td><td>—</td></tr>
      </tbody>
      <tfoot><tr><td></td><td>Сума балів</td><td>—</td><td id="sum">0</td></tr></tfoot>
    </table>

    <div class="actions">
      <button class="btn" id="editBtn">Редагувати</button>
      <button class="btn primary" id="genBtn" disabled>Генерувати</button>
    </div>
  </div>

  <div id="loadBox" class="loading">Дані шкал завантажуються…</div>
  <div id="warnBox" class="warn hidden">
    <div style="font-weight:700">Не знайдено вправ</div>
    <div class="small">Перевір лінки на CSV:<br>
      <a href="./data/scales_men.csv" target="_blank">./data/scales_men.csv</a> ·
      <a href="./data/scales_women.csv" target="_blank">./data/scales_women.csv</a><br>
      <a href="./data/thresholds_men.csv" target="_blank">./data/thresholds_men.csv</a> ·
      <a href="./data/thresholds_women.csv" target="_blank">./data/thresholds_women.csv</a><br>
      Імена та регістр мають збігатися точно.
    </div>
  </div>
</div>

<div class="modal-back" id="modalBack">
  <div class="modal">
    <div class="topbar2">
      <div style="font-weight:700">Обери 3 вправи</div>
      <button class="btn" id="closeModal">Закрити</button>
    </div>
    <div class="cards" id="cardList"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div id="selCount" class="muted">Обрано: 0/3</div>
      <button class="btn primary" id="applySel" disabled>Готово</button>
    </div>
  </div>
</div>

<script>
const VER='r28';
const GROUPED='__GROUP_PULL_KSV__';
let category='2', sex='M', ageGroup=2, grade=3;
let picked=[GROUPED];
const state={ thresholds:{M:[],J:[]}, scales:{M:null,J:null}, ready:false, choices:[] };

const randint=(a,b)=>Math.floor(a+Math.random()*(b-a+1));
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const onlyNumber = s => { const m=String(s||'').match(/(\\d+)/); return m?parseInt(m[1],10):0 };
const toNumber = s => { const m=String(s||'').replace(/[^0-9-]/g,''); return m?parseInt(m,10):NaN; }
const stripQuotes = s => String(s??'').replace(/^\\s*[\\\"'«»]+|[\\\"'«»]+\\s*$/g,'').trim();
function pickDelim(first){
  if(first.includes('\\t')) return '\\t';
  if(first.includes('\\u0009')) return '\\t';
  if(first.includes(';')) return ';';
  if(first.includes('|')) return '|';
  if(first.includes(',')) return ',';
  return '\\t';
}
function parseCSVLine(line, delim){
  if(delim==='\\t') delim = '\\t'.replace('\\\\t','\\t');
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){ if(q && line[i+1]==='\"'){ cur+='\"'; i++; } else { q=!q; } }
    else if(ch===delim && !q){ out.push(cur); cur=''; }
    else{ cur+=ch; }
  }
  out.push(cur);
  return out.map(c=>stripQuotes(c));
}
async function fetchText(url){
  const full = url + `?v=${VER}&t=${Date.now()}`;
  const r = await fetch(full, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status+' @ '+url);
  return r.text();
}

/* ШКАЛИ */
async function loadScales(url){
  const txt=(await fetchText(url)).replace(/^\\uFEFF/,'');
  const lines=txt.split(/\\r?\\n/).filter(x=>x.trim().length);
  if(!lines.length) return {};
  const delim=pickDelim(lines[0]);
  const rows=lines.map(line=>parseCSVLine(line,delim));
  const headerJoin = rows[0].join(' ').toLowerCase();
  const hasHeader = /назва|одиниц|бал|результат/.test(headerJoin);
  const data = hasHeader ? rows.slice(1) : rows;
  const byName={};
  for(const cols of data){
    if(!cols.length) continue;
    let id='', name='', unit='', pts='', res='';
    const first=cols[0];
    const looksLikeID = /^\\d+[a-zа-я]?$/.test(first); // підтримує 32б
    if(looksLikeID && cols.length>=5){
      [id,name,unit,pts,res]=[cols[0],cols[1],cols[2],cols[3],cols[4]];
    }else{
      [name,unit,pts,res]=[cols[0]||'',cols[1]||'',cols[2]||'',cols[3]||''];
    }
    name=stripQuotes(name);
    if(!name) continue;
    const points = parseInt(String(pts||'').replace(/\\s/g,''),10);
    if(!Number.isFinite(points)) continue;
    if(!byName[name]) byName[name] = { id: (id||'—'), unit, map:{} };
    byName[name].map[points] = stripQuotes(res);
  }
  return byName;
}

/* ПОРОГИ */
function numericColStats(rows, ignoreIdx=new Set()){
  const idxs=[...Array(rows[0].length).keys()].filter(i=>!ignoreIdx.has(i));
  return idxs.map(i=>{
    const nums = rows.slice(1).map(r=>toNumber(r[i])).filter(v=>Number.isFinite(v));
    const sorted=[...nums].sort((a,b)=>a-b);
    const median = sorted.length? sorted[Math.floor(sorted.length/2)] : -Infinity;
    const avg = sorted.length? sorted.reduce((a,b)=>a+b,0)/sorted.length : -Infinity;
    return {i, count:nums.length, median, avg};
  });
}
async function loadThresholds(url){
  const txt=(await fetchText(url)).replace(/^\\uFEFF/,'');
  const lines=txt.split(/\\r?\\n/).filter(x=>x.trim().length);
  const delim=pickDelim(lines[0]||'');
  if(!lines.length) return [];
  const rows=lines.map(line=>parseCSVLine(line,delim));
  const headers = rows[0].map(h=>h.trim().toLowerCase());
  const idx = name => headers.indexOf(name);
  const iAge = Math.max(idx('вік'), idx('вікова група'), idx('возрастная группа'), idx('age_group'), idx('група'), idx('группа'));
  const iCat = Math.max(idx('категорія'), idx('категория'), idx('category'));
  const iMin = Math.max(idx('пороговий мінімум'), idx('пороговый минимум'), idx('min_per_exercise'));
  const findSumCol = (digit) => {
    let i = headers.findIndex(h => /з\\s*3\\s*вправ|із\\s*тр(ь|и)ох\\s*вправ|сума/.test(h) && new RegExp(`[«\\(\\s\\-]${digit}[»\\)\\s]*$`).test(h));
    if (i<0) i = headers.findIndex(h => /sum_for_grade_\\d+/.test(h) && h.endsWith(String(digit)));
    if (i<0) i = headers.findIndex(h => /\\b\\(?[345]\\)?$/.test(h) && h.includes('вправ'));
    return i;
  };
  let iS3 = findSumCol(3);
  let iS4 = findSumCol(4);
  let iS5 = findSumCol(5);

  // Fallback: auto-detect 3 biggest numeric columns (ascending medians)
  if(iS3<0 || iS4<0 || iS5<0){
    const ignore = new Set([iAge, iCat, iMin].filter(i=>i>=0));
    const stats = numericColStats(rows, ignore).filter(s=>s.count>=Math.max(2, Math.floor((rows.length-1)*0.5)));
    const top = stats.sort((a,b)=>b.median-a.median).slice(0,5).sort((a,b)=>a.median-b.median);
    if(top.length>=3){
      iS3 = top[0].i; iS4 = top[1].i; iS5 = top[2].i;
    }
  }

  return rows.slice(1).map(c=>{
    const get=(i)=> (i>=0 && i<c.length)? stripQuotes(c[i]) : '';
    return {
      age_group: get(iAge),
      category: (get(iCat)||'').replace(/[\\s\\u00A0]/g,'').replace(/[,;]+/g,','),
      min_per_exercise: get(iMin),
      sum_for_grade_3: get(iS3),
      sum_for_grade_4: get(iS4),
      sum_for_grade_5: get(iS5),
    };
  });
}

/* Список */
function namesFrom(scales){ try{ return Object.keys(scales||{}); }catch{ return []; } }
function findBy(names, re){ re = (re instanceof RegExp)? re : new RegExp(re,'i'); return names.find(n=>re.test(n)); }
function computeChoices(){
  const scales = (sex==='M'?state.scales.M:state.scales.J)||{};
  const names = namesFrom(scales);
  state.choices = names;
  const warn = document.getElementById('warnBox');
  if(!names.length){
    warn.classList.remove('hidden');
  }else{
    warn.classList.add('hidden');
  }
  const med   = findBy(names, /медбол/i);
  const func  = findBy(names, /функц|витривал/i);
  const pull  = findBy(names, /підтяг|подтяг/i);
  const ksv   = findBy(names, /комплексн.*силов/i);
  const first = med || names[0] || '—';
  const second= func || names.find(n=>n!==first) || first;
  picked = [ first, (pull||ksv)? GROUPED : (pull||ksv), second ].filter(Boolean).slice(0,3);
}

/* Завантаження */
async function loadAll(){
  const dataState=document.getElementById('dataState');
  try{
    const [thM, thW, scM, scW] = await Promise.allSettled([
      loadThresholds('./data/thresholds_men.csv'),
      loadThresholds('./data/thresholds_women.csv'),
      loadScales('./data/scales_men.csv'),
      loadScales('./data/scales_women.csv'),
    ]);
    state.thresholds.M = thM.status==='fulfilled' ? thM.value : [];
    state.thresholds.J = thW.status==='fulfilled' ? thW.value : [];
    state.scales.M = scM.status==='fulfilled' ? scM.value : {};
    state.scales.J = scW.status==='fulfilled' ? scW.value : {};
    state.ready = true;
    const mCount=Object.keys(state.scales.M||{}).length, wCount=Object.keys(state.scales.J||{}).length;
    dataState.textContent = `OK: М(${mCount}) Ж(${wCount})`;
    computeChoices();
    renderPicked();
    buildCards();
    document.getElementById('genBtn').disabled=false;
    document.getElementById('loadBox').classList.add('hidden');
  }catch(e){
    dataState.textContent='Помилка завантаження';
    document.getElementById('loadBox').textContent='Помилка CSV: '+e.message;
    console.error(e);
  }
}

/* UI */
const ageGrid = document.getElementById('ageGrid');
for(let g=1;g<=7;g++){
  const lab=document.createElement('label'); lab.className='inline';
  const inp=document.createElement('input'); inp.type='checkbox'; inp.checked=(g===ageGroup);
  inp.addEventListener('change',()=>{ageGroup=g;[...ageGrid.querySelectorAll('input')].forEach((el,idx)=>el.checked=(idx+1)===g);});
  lab.appendChild(inp); lab.appendChild(document.createTextNode(' '+g)); ageGrid.appendChild(lab);
}
document.querySelectorAll('input[name="cat"]').forEach(r=>r.addEventListener('change',e=>{category=e.target.value;}));
document.querySelectorAll('input[name="sex"]').forEach(r=>r.addEventListener('change',e=>{sex=e.target.value; computeChoices(); renderPicked(); buildCards(); }));
document.querySelectorAll('input[name="grade"]').forEach(r=>r.addEventListener('change',e=>{grade=parseInt(e.target.value,10);}))

const tbody=document.getElementById('tbody'); const sumEl=document.getElementById('sum');
function renderRows(rows){
  tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="idcell"><span class="idpill">${r.badge||'—'}</span></td><td>${r.displayName}</td><td>${r.result}</td><td>${r.points}</td>`;
    tbody.appendChild(tr);
  });
  const total=rows.reduce((a,r)=>a+(isFinite(+r.points)?+r.points:0),0);
  sumEl.textContent=total;
}
function renderPicked(){
  const scales = (sex==='M'?state.scales.M:state.scales.J) || {};
  const rows = picked.map(n=>{
    if(n===GROUPED) return {name:GROUPED, displayName:'Підтягування / КСВ', result:'—',points:'—',badge:'2/14'};
    const info = scales[n];
    const badge = info? String(info.id||'—') : '—';
    return {name:n, displayName:n, result:'—',points:'—',badge};
  });
  renderRows(rows);
}

/* Модал */
const modalBack=document.getElementById('modalBack');
const editBtn=document.getElementById('editBtn');
const closeModal=document.getElementById('closeModal');
const applySel=document.getElementById('applySel');
const cardList=document.getElementById('cardList');
const selCount=document.getElementById('selCount');

function buildCards(){
  cardList.innerHTML='';
  let temp=[...picked];
  const all = state.choices || [];
  const names = all.filter(n=>!(/підтяг|подтяг/i.test(n) || /комплексн.*силов/i.test(n)));

  const hasPull = all.some(n=>/підтяг|подтяг/i.test(n));
  const hasKsv  = all.some(n=>/комплексн.*силов/i.test(n));
  if(hasPull||hasKsv){
    const div=document.createElement('div');
    div.className='card'+(temp.includes(GROUPED)?' sel':'');
    div.textContent='Підтягування / КСВ';
    div.addEventListener('click',()=>{
      const i=temp.indexOf(GROUPED);
      if(i>=0) temp.splice(i,1); else { if(temp.length>=3) return; temp.push(GROUPED); }
      picked=[...temp]; buildCards();
    });
    cardList.appendChild(div);
  }
  if(!names.length){
    const msg=document.createElement('div');
    msg.className='muted';
    msg.textContent='Список вправ порожній — перевір CSV.';
    cardList.appendChild(msg);
  }else{
    names.forEach(name=>{
      const div=document.createElement('div');
      div.className='card'+(temp.includes(name)?' sel':'');
      div.textContent = name;
      div.addEventListener('click',()=>{
        const i=temp.indexOf(name);
        if(i>=0) temp.splice(i,1); else { if(temp.length>=3) return; temp.push(name); }
        picked=[...temp]; buildCards();
      });
      cardList.appendChild(div);
    });
  }
  selCount.textContent=`Обрано: ${picked.length}/3`;
  applySel.disabled=(picked.length!==3);
}
editBtn.addEventListener('click',()=>{buildCards(); modalBack.style.display='flex';});
closeModal.addEventListener('click',()=>{modalBack.style.display='none';});
applySel.addEventListener('click',()=>{ if(picked.length!==3) return; renderPicked(); modalBack.style.display='none';});

/* Вариація результата в межах балу */
function decimalsCount(s){ const m=String(s).match(/,(\\d+)/); return m? m[1].length : 0; }
function formatDecComma(x, decs){ return x.toFixed(decs).replace('.',','); }
function parseMinSec_csv(s){ const [m,sec]=String(s).split(',').map(x=>parseInt(x,10)); return {total: (m||0)*60 + (sec||0)}; }
function toMinSec_csv(total){ total=Math.max(0,total|0); const m=Math.floor(total/60), s=total%60; return `${m},${String(s).padStart(2,'0')}`; }
function isLowerBetter(name, unit){ const u=(unit||'').toLowerCase(), n=(name||'').toLowerCase(); if(u.includes('с')||u.includes('хв')) return true; if(n.includes('біг')||n.includes('бег')) return true; return false; }
function isReps(unit){ return /раз|рази/i.test(unit); }
function isMeters(unit){ return /\\bм\\b/i.test(unit); }
function isMedball(name){ return /медбол/i.test(name); }
function isEndurance(name){ return /витривал/i.test(name); }
function isHundred(name){ return /100\\s*м/i.test(name); }

function variedResult(name, unit, pts, map){
  const base = stripQuotes(map[pts]);
  if(!base) return null;
  const next = map[pts+1];
  if(!next) return base;
  const betterIsLower = isLowerBetter(name, unit);

  if(/км/i.test(name) || /хв/i.test(unit)){
    const a=parseMinSec_csv(base).total, b=parseMinSec_csv(stripQuotes(next)).total;
    const lo = betterIsLower ? b : a;
    const hi = betterIsLower ? a : b;
    if(hi<=lo) return base;
    return toMinSec_csv(randint(lo,hi-1));
  }
  if(isHundred(name)){
    const a = parseFloat(String(base).replace(',','.'));
    const b = parseFloat(String(stripQuotes(next)).replace(',','.'));
    if(!Number.isFinite(a)||!Number.isFinite(b)) return base;
    let from,to;
    if(betterIsLower){ from=b; to=a; } else { from=a; to=b; }
    if(to<=from) return base;
    const step=0.1;
    const kFrom=Math.ceil((from+1e-9)/step), kTo=Math.floor((to-1e-9)/step);
    if(kTo<kFrom) return base;
    const k=randint(kFrom,kTo);
    return formatDecComma(k*step, 1);
  }
  if(isMedball(name)){
    const a = parseFloat(String(base).replace(',','.'));
    const b = parseFloat(String(stripQuotes(next)).replace(',','.'));
    if(!Number.isFinite(a)||!Number.isFinite(b)) return base;
    let from,to;
    if(betterIsLower){ from=b; to=a; } else { from=a; to=b; }
    if(to<=from) return base;
    const step=0.05;
    const kFrom=Math.ceil((from+1e-9)/step), kTo=Math.floor((to-1e-9)/step);
    if(kTo<kFrom) return base;
    const k=randint(kFrom,kTo);
    return formatDecComma(k*step, 2);
  }
  if(isEndurance(name) || (isMeters(unit) && !isMedball(name) && !isHundred(name))){
    const a=parseInt(base,10), b=parseInt(stripQuotes(next),10);
    if(!Number.isFinite(a)||!Number.isFinite(b)) return base;
    const lo = betterIsLower ? (b+1) : a;
    const hi = betterIsLower ? a : (b-1);
    if(hi<lo) return base;
    return String(randint(lo,hi));
  }
  if(isReps(unit)){
    const a=parseInt(base,10), b=parseInt(stripQuotes(next),10);
    if(!Number.isFinite(a)||!Number.isFinite(b)) return base;
    const lo = betterIsLower ? (b+1) : a;
    const hi = betterIsLower ? a : (b-1);
    if(hi<lo) return base;
    return String(randint(lo,hi));
  }
  return base;
}

/* Пороги */
function activeThreshold(){
  const list=(sex==='M'?state.thresholds.M:state.thresholds.J);
  if(!list || !list.length) return null;
  const need=(category==='3'?'3,4':'2');
  let best=null,bestDiff=1e9;
  for(const r of list){
    const cat=(String(r.category||'').replace(/[\\s\\u00A0]/g,'').replace(/[,;]+/g,','))||'';
    if(cat!==need) continue;
    const g=parseInt(r.age_group,10); if(!Number.isFinite(g)) continue;
    const d=Math.abs(g-ageGroup);
    if(d<bestDiff){best=r;bestDiff=d;}
  }
  if(!best){
    for(const r of list){
      const g=parseInt(r.age_group,10); if(!Number.isFinite(g)) continue;
      const d=Math.abs(g-ageGroup);
      if(d<bestDiff){best=r;bestDiff=d;}
    }
  }
  return best;
}

/* Вероятности по оценкам */
function sampleSkewed(minSum, nextSum){
  const x=Math.max(1,nextSum-minSum);
  const r=Math.random();
  let lo=minSum, hi=minSum+Math.floor(0.3*x);
  if(r>=0.8 && r<0.95){ lo=minSum+Math.floor(0.3*x); hi=minSum+Math.floor(0.5*x); }
  else if(r>=0.95){ lo=minSum+Math.floor(0.5*x); hi=minSum+Math.floor(0.7*x); }
  hi=Math.min(hi,nextSum-1);
  if(hi<lo) hi=lo;
  return randint(lo,hi);
}
function randn(){ let u=0,v=0; while(!u)u=Math.random(); while(!v)v=Math.random(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }
function sampleTruncNormal(a,b,mean,sd){
  for(let i=0;i<16;i++){
    const x = mean + sd*randn();
    if(x>=a && x<=b) return Math.round(x);
  }
  return randint(Math.ceil(a), Math.floor(b));
}

/* Підтягування/КСВ */
function choosePullOrKsv(scales){
  const names = Object.keys(scales);
  const pull = names.find(n=>/підтяг|подтяг/i.test(n));
  const ksv  = names.find(n=>/комплексн.*силов/i.test(n));
  if(!pull && !ksv) return null;
  return (Math.random()<0.8 ? (pull||ksv) : (ksv||pull));
}

/* Генерація */
function generateOnce(){
  const th=activeThreshold()||{min_per_exercise:'10',sum_for_grade_3:'60',sum_for_grade_4:'80',sum_for_grade_5:'95'};
  const minPer=onlyNumber(th.min_per_exercise);
  let s3=onlyNumber(th.sum_for_grade_3), s4=onlyNumber(th.sum_for_grade_4), s5=onlyNumber(th.sum_for_grade_5);

  // страховки
  if(!s3 && s4){ s3=Math.max(1, Math.round(s4*0.8)); }
  if(!s4 && s5){ s4=Math.max(s3+1, Math.round(s5*0.9)); }
  if(!s5 && s4){ s5=Math.max(s4+1, Math.round(s4*1.1)); }

  let minSum,nextSum,target;
  if(grade===5){
    minSum=s5; nextSum=s5 + Math.max(2, Math.round(0.1*s5));
    target=sampleSkewed(minSum,nextSum);
  } else if(grade===4){
    minSum=s4; nextSum=Math.max(s4+1, s5||s4+10);
    target=sampleSkewed(minSum,nextSum);
  } else if(grade===3){
    minSum=s3; nextSum=Math.max(s3+1, s4||s3+10);
    target=sampleSkewed(minSum,nextSum);
  } else { // grade===2
    const hi = Math.max(0, s3-1);
    const lo = Math.max(0, Math.ceil(s3 - 0.3*s3));
    const mean = hi - (hi-lo)*0.2; // ближе к порогу тройки
    const sd = (hi-lo)/6 || 1;
    target = clamp(sampleTruncNormal(lo, hi, mean, sd), lo, hi);
  }

  const scales = (sex==='M'?state.scales.M:state.scales.J) || {};
  let names = picked.map(n=> n===GROUPED ? choosePullOrKsv(scales) : n);
  if(names.includes(null)) return null;
  for(const n of names){ if(!scales[n]) return null; }

  const allowed = names.map(n => Object.keys(scales[n].map).map(x=>parseInt(x,10)).filter(v=>v>=minPer).sort((a,b)=>b-a));
  const meanPts=target/3; const devMax=(Math.random()<0.8?0.30:0.40)*meanPts;
  const loPts=Math.max(minPer,Math.floor(meanPts-devMax)); const hiPts=Math.ceil(meanPts+devMax);
  const resFor = (n,pts) => {
    const s=scales[n]; if(!s) return null;
    const base = s.map[pts]; if(!base || base==='-' || base==='—') return null;
    const v = variedResult(n, s.unit, pts, s.map);
    return v||base;
  };

  for(let tries=0; tries<15000; tries++){
    const c1=allowed[0].filter(v=>v>=loPts&&v<=hiPts);
    const c2=allowed[1].filter(v=>v>=loPts&&v<=hiPts);
    if(!c1.length||!c2.length) break;
    const v1=c1[Math.floor(Math.random()*c1.length)];
    const v2=c2[Math.floor(Math.random()*c2.length)];
    const v3=target-v1-v2; if(v3<loPts||v3>hiPts) continue; if(!allowed[2].includes(v3)) continue;
    const r1=resFor(names[0],v1), r2=resFor(names[1],v2), r3=resFor(names[2],v3);
    if(!r1||!r2||!r3) continue;
    return [
      {name:names[0], displayName:names[0], points:v1, result:r1, badge:(scales[names[0]].id||'—')},
      {name:names[1], displayName:names[1], points:v2, result:r2, badge:(scales[names[1]].id||'—')},
      {name:names[2], displayName:names[2], points: v3, result:r3, badge:(scales[names[2]].id||'—')},
    ];
  }
  return null;
}
function generate(){
  if(!state.ready){ return; }
  let solution=null;
  for(let attempt=0; attempt<100 && !solution; attempt++){
    solution = generateOnce();
  }
  if(solution){ renderRows(solution); }
}

/* События */
document.getElementById('genBtn').addEventListener('click',generate);

/* Старт */
loadAll();
</script>
</body>
</html>