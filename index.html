<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="apple-touch-icon" href="Icons/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Генератор</title>
    <style>
      :root{--bg:#f6f9ff;--bg2:#eef2ff;--fg:#0f172a;--muted:#64748b;--card:#ffffff;--br:#e2e8f0;--acc:#0f172a}
      *{box-sizing:border-box} html,body{height:100%}
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;color:var(--fg);
        background:radial-gradient(1200px 500px at 0% -10%, var(--bg2), transparent 60%), linear-gradient(180deg, var(--bg), #fff 60%)}
      .wrap{max-width:100%;margin:0 auto;padding:12px}
      .topbar{display:flex;gap:10px;align-items:center;margin:6px 2px 10px}
      .logo{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#0f172a;color:#fff;font-weight:800;font-size:14px}
      .chip{padding:4px 8px;border:1px solid var(--br);border-radius:999px;font-size:12px;color:var(--muted)}
      fieldset{border:1px solid var(--br);border-radius:12px;padding:10px 12px;min-width:min(100%,260px);background:var(--card)}
      legend{font-size:12px;color:var(--muted);padding:0 6px}
      .row{display:flex;gap:12px;flex-wrap:nowrap}
      .row + .row{margin-top:10px}
      .controls{display:flex;align-items:center;gap:10px}
      .tight .controls{gap:8px}
      .age-grid{display:grid;grid-template-columns:repeat(7,minmax(28px,1fr));gap:6px}
      label.inline{display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
      table{width:100%;border-collapse:collapse;background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 6px 24px rgba(2,6,23,.06)}
      thead{background:#f1f5f9;color:#475569;font-size:14px}
      th,td{padding:10px 12px;border-top:1px solid var(--br)}
      tfoot td{background:#f8fafc;font-weight:600}
      .btn{appearance:none;border:1px solid var(--br);background:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700}
      .btn.primary{background:var(--acc);color:#fff;border-color:#0b1220}
      .btn:disabled{opacity:.5;cursor:not-allowed}
      .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
      .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:12px;z-index:100}
      .modal{background:#fff;border-radius:16px;max-width:640px;width:100%;padding:14px}
      .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
      .card{border:1px solid var(--br);border-radius:12px;padding:12px;cursor:pointer;box-shadow:0 2px 10px rgba(2,6,23,.04)}
      .card.sel{background:#ecfdf5;border-color:#34d399}
      .topbar2{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
      .hidden{display:none}
      .loading{padding:8px 10px;border:1px dashed var(--br);border-radius:10px;background:#fff}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="topbar">
        <div class="logo">NG</div>
        <div class="chip">Генератор оцінки</div>
        <div id="dataState" class="chip">Загрузка…</div>
      </div>

      <!-- 1-я строка: Категория + Пол -->
      <div class="row">
        <fieldset class="tight">
          <legend>Категорія</legend>
          <div class="controls">
            <label class="inline"><input type="radio" name="cat" value="2" checked> <span>2</span></label>
            <label class="inline"><input type="radio" name="cat" value="3"> <span>3</span></label>
          </div>
        </fieldset>
        <fieldset class="tight">
          <legend>Стать</legend>
          <div class="controls">
            <label class="inline"><input type="radio" name="sex" value="M" checked> <span>М</span></label>
            <label class="inline"><input type="radio" name="sex" value="J"> <span>Ж</span></label>
          </div>
        </fieldset>
      </div>

      <!-- 2-я строка: Возраст под ней Оценка -->
      <div class="row" style="flex-direction:column">
        <fieldset>
          <legend>Вікова група (1–7)</legend>
          <div class="age-grid" id="ageGrid"></div>
        </fieldset>
        <fieldset style="margin-top:10px">
          <legend>Оцінка</legend>
          <div class="controls">
            <label class="inline"><input type="radio" name="grade" value="2"> <span>2</span></label>
            <label class="inline"><input type="radio" name="grade" value="3" checked> <span>3</span></label>
            <label class="inline"><input type="radio" name="grade" value="4"> <span>4</span></label>
            <label class="inline"><input type="radio" name="grade" value="5"> <span>5</span></label>
          </div>
        </fieldset>
      </div>

      <!-- Таблица + кнопки снизу -->
      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Упражнение</th><th>Результат</th><th style="width:120px">Бал</th></tr></thead>
          <tbody id="tbody">
            <tr><td>Медбол</td><td>—</td><td>—</td></tr>
            <tr><td>Підтягування / КСВ</td><td>—</td><td>—</td></tr>
            <tr><td>Функц. витривалість</td><td>—</td><td>—</td></tr>
          </tbody>
          <tfoot><tr><td>Сумма баллов</td><td>—</td><td id="sum">0</td></tr></tfoot>
        </table>
        <div class="actions">
          <button class="btn" id="editBtn">Редактировать</button>
          <button class="btn primary" id="genBtn" disabled>Сгенерировать</button>
        </div>
      </div>

      <div id="loadBox" class="loading">Данные шкал загружаются…</div>
    </div>

    <!-- Модалка выбора 3 упражнений -->
    <div class="modal-back" id="modalBack">
      <div class="modal">
        <div class="topbar2">
          <div style="font-weight:700">Выбери 3 упражнения</div>
          <button class="btn" id="closeModal">Закрыть</button>
        </div>
        <div class="cards" id="cardList"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div id="selCount" class="chip">Выбрано: 0/3</div>
          <button class="btn primary" id="applySel" disabled>Готово</button>
        </div>
      </div>
    </div>

    <script>
      const GROUPED_ID = '2or14';
      let category='2', sex='M', ageGroup=2, grade=3;
      let picked = ['1', GROUPED_ID, '32б'];

      async function loadCSV(url, delim=';'){
        const t = await fetch(url).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status+' @ '+url); return r.text(); });
        const lines = t.replace(/\r/g,'').split('\n').filter(x=>x.trim().length);
        const head = lines[0].split(delim).map(h=>h.trim());
        return lines.slice(1).map(line=>{
          const cols = line.split(delim).map(c=>c.trim()); const o={};
          head.forEach((h,i)=> o[h] = (cols[i]??'')); return o;
        });
      }

      const state = { thresholds:{M:[],J:[]}, scales:{M:{},J:{}}, ready:false };

      async function loadAll(){
        const badge = document.getElementById('dataState');
        try{
          const [thM, thW, scM, scW] = await Promise.all([
            loadCSV('./data/thresholds_men.csv'),
            loadCSV('./data/thresholds_women.csv'),
            loadCSV('./data/scales_men.csv'),
            loadCSV('./data/scales_women.csv'),
          ]);
          state.thresholds.M = thM; state.thresholds.J = thW;

          function toScales(rows){
            const byId={};
            for(const r of rows){
              const id=r.exercise_id;
              if(!byId[id]) byId[id]={name:r.exercise_name, unit:r.unit, map:{}};
              byId[id].map[parseInt(r.points,10)] = r.result;
            }
            return byId;
          }
          state.scales.M = toScales(scM);
          state.scales.J = toScales(scW);

          badge.textContent='Данные загружены';
          document.getElementById('genBtn').disabled=false;
          document.getElementById('loadBox').classList.add('hidden');
          state.ready=true;
        }catch(e){
          badge.textContent='Ошибка загрузки';
          document.getElementById('loadBox').textContent='Ошибка: '+e.message;
          console.error(e);
        }
      }

      // UI init
      const ageGrid = document.getElementById('ageGrid');
      for(let g=1; g<=7; g++){
        const lab=document.createElement('label'); lab.className='inline';
        const inp=document.createElement('input'); inp.type='checkbox'; inp.checked=(g===ageGroup);
        inp.addEventListener('change', ()=>{ ageGroup=g; [...ageGrid.querySelectorAll('input')].forEach((el,i)=> el.checked=(i+1)===g); });
        lab.appendChild(inp); lab.appendChild(document.createTextNode(' '+g)); ageGrid.appendChild(lab);
      }
      document.querySelectorAll('input[name="cat"]').forEach(r=>r.addEventListener('change',e=>category=e.target.value));
      document.querySelectorAll('input[name="sex"]').forEach(r=>r.addEventListener('change',e=>sex=e.target.value));
      document.querySelectorAll('input[name="grade"]').forEach(r=>r.addEventListener('change',e=>grade=parseInt(e.target.value,10)));

      const tbody = document.getElementById('tbody'), sumEl=document.getElementById('sum');
      function renderRows(rows){
        tbody.innerHTML='';
        rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.label}</td><td>${r.result}</td><td>${r.points}</td>`; tbody.appendChild(tr); });
        sumEl.textContent = rows.reduce((a,r)=>a+(isFinite(+r.points)?+r.points:0),0);
      }
      renderRows([{id:'1',label:'Медбол',result:'—',points:'—'},{id:GROUPED_ID,label:'Підтягування / КСВ',result:'—',points:'—'},{id:'32б',label:'Функц. витривалість',result:'—',points:'—'}]);

      // выбор 3 упражнений
      const modalBack=document.getElementById('modalBack'), editBtn=document.getElementById('editBtn'), closeModal=document.getElementById('closeModal'), applySel=document.getElementById('applySel'), cardList=document.getElementById('cardList'), selCount=document.getElementById('selCount'); const CHOICES=['1',GROUPED_ID,'28','31','32б']; let tempPicked=[...picked];
      function labelFor(id){ if(id==='1') return 'Медбол'; if(id==='2') return 'Підтягування'; if(id==='14') return 'КСВ'; if(id==='28') return '100 м'; if(id==='31') return '1 км'; if(id==='32б') return 'Функц. витривалість'; if(id===GROUPED_ID) return 'Підтягування / КСВ'; return id; }
      function buildCards(){ cardList.innerHTML=''; CHOICES.forEach(id=>{ const div=document.createElement('div'); div.className='card'+(tempPicked.includes(id)?' sel':''); div.textContent=labelFor(id); div.addEventListener('click',()=>{ const i=tempPicked.indexOf(id); if(i>=0) tempPicked.splice(i,1); else { if(tempPicked.length>=3) return; tempPicked.push(id);} buildCards(); }); cardList.appendChild(div); }); selCount.textContent=`Выбрано: ${tempPicked.length}/3`; applySel.disabled = tempPicked.length!==3; }
      editBtn.addEventListener('click',()=>{ tempPicked=[...picked]; buildCards(); modalBack.style.display='flex'; });
      closeModal.addEventListener('click',()=> modalBack.style.display='none');
      applySel.addEventListener('click',()=>{ if(tempPicked.length!==3) return; picked=[...tempPicked]; renderRows(picked.map(id=>({id,label:labelFor(id),result:'—',points:'—'}))); modalBack.style.display='none'; });

      // генерация
      function onlyNumber(s){ const m=String(s||'').match(/(\d+)/); return m?parseInt(m[1],10):0 }
      function randint(a,b){return Math.floor(a+Math.random()*(b-a+1))}
      function activeThreshold(){
        const list = (sex==='M'? state.thresholds.M : state.thresholds.J);
        const catVal = (category==='3'? '3,4':'2');
        let best=null, bestDiff=999;
        for(const r of list){
          if((r.category||'').replace(/\s/g,'') !== catVal) continue;
          const g = parseInt(r.age_group,10), d = Math.abs(g-ageGroup);
          if(d<bestDiff){ best=r; bestDiff=d; }
        }
        return best;
      }
      function getScales(){ return sex==='M'? state.scales.M : state.scales.J }

      function generate(){
        if(!state.ready){ alert('Данные ещё не загружены'); return; }
        const th = activeThreshold(); if(!th){ alert('Нет данных порогов'); return; }
        const minPer = onlyNumber(th.min_per_exercise);
        const s5=onlyNumber(th.sum_for_grade_5), s4=onlyNumber(th.sum_for_grade_4), s3=onlyNumber(th.sum_for_grade_3);
        let minSum,nextSum;
        if(grade===5){minSum=s5;nextSum=null}
        else if(grade===4){minSum=s4;nextSum=s5}
        else if(grade===3){minSum=s3;nextSum=s4}
        else {minSum=3*minPer; nextSum=s3? s3:(minSum+15)}

        let target;
        if(!nextSum){ target=minSum; }
        else{
          const x=Math.max(1,nextSum-minSum), r=Math.random();
          let lo=minSum, hi=minSum+Math.floor(0.3*x);
          if(r>=0.8 && r<0.95){ lo=minSum+Math.floor(0.3*x); hi=minSum+Math.floor(0.5*x); }
          else if(r>=0.95){ lo=minSum+Math.floor(0.5*x); hi=minSum+Math.floor(0.7*x); }
          if(hi>=nextSum) hi=nextSum-1; if(hi<lo) hi=lo; target=randint(lo,hi);
        }

        const scales=getScales();
        let ids=[...picked];
        if(ids.includes(GROUPED_ID)){
          ids = ids.map(id=> id===GROUPED_ID ? (sex==='J' ? '14' : (Math.random()<0.8?'2':'14')) : id);
        }
        for(const id of ids){ if(!scales[id]){ alert('Нет шкалы для '+labelFor(id)); return; } }

        const allowed=ids.map(id=> Object.keys(scales[id].map).map(x=>parseInt(x,10)).filter(v=>v>=minPer).sort((a,b)=>b-a));
        const mean=target/3, devMax=(Math.random()<0.8?0.30:0.40)*mean, lo=Math.max(minPer,Math.floor(mean-devMax)), hi=Math.ceil(mean+devMax);
        function resFor(id,pts){const m=scales[id].map; return (m[pts]&&m[pts]!=='-'&&m[pts]!=='—')?m[pts]:null}

        let solution=null;
        outer: for(let t=0;t<8000;t++){
          const c1=allowed[0].filter(v=>v>=lo&&v<=hi), c2=allowed[1].filter(v=>v>=lo&&v<=hi);
          if(!c1.length||!c2.length) break;
          const v1=c1[Math.floor(Math.random()*c1.length)], v2=c2[Math.floor(Math.random()*c2.length)];
          const v3=target-v1-v2; if(v3<lo||v3>hi) continue; if(!allowed[2].includes(v3)) continue;
          const r1=resFor(ids[0],v1), r2=resFor(ids[1],v2), r3=resFor(ids[2],v3); if(!r1||!r2||!r3) continue;
          solution=[{id:ids[0],label:labelFor(ids[0]),points:v1,result:r1},{id:ids[1],label:labelFor(ids[1]),points:v2,result:r2},{id:ids[2],label:labelFor(ids[2]),points:v3,result:r3}];
          break outer;
        }
        if(!solution){ alert('Не удалось подобрать баллы под условия. Измени параметры или шкалы.'); return; }
        renderRows(solution.map(s=>({id:s.id,label:s.label,result:s.result,points:s.points})));
      }

      document.getElementById('genBtn').addEventListener('click',generate);

      if('serviceWorker' in navigator){
        window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js',{scope:'./'}).catch(console.error); });
      }
      loadAll();
    </script>
  </body>
  </html>
