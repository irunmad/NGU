<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#0f172a"/>
<link rel="manifest" href="manifest.webmanifest"/>
<link rel="apple-touch-icon" href="Icons/icon-192.png">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Генератор</title>
<style>
:root{--bg:#f6f9ff;--bg2:#eef2ff;--fg:#0f172a;--muted:#64748b;--card:#fff;--br:#e2e8f0;--acc:#0f172a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;color:var(--fg);
background:radial-gradient(1200px 500px at 0% -10%,var(--bg2),transparent 60%),linear-gradient(180deg,var(--bg),#fff 60%)}
.wrap{max-width:100%;margin:0 auto;padding:12px}
.topbar{display:flex;gap:10px;align-items:center;margin:6px 2px 10px}
.logo{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#0f172a;color:#fff;font-weight:800;font-size:14px;letter-spacing:1px}
.chip{padding:4px 8px;border:1px solid var(--br);border-radius:999px;font-size:12px;color:var(--muted)}
fieldset{border:1px solid var(--br);border-radius:12px;padding:6px 10px;background:var(--card);width:fit-content}
legend{font-size:12px;color:var(--muted);padding:0 6px}
.tight{display:inline-flex;align-items:center;gap:10px;min-width:0}
.controls{display:flex;align-items:center;gap:10px;flex-wrap:nowrap}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
.row + .row{margin-top:10px}
.age-grid{display:grid;grid-template-columns:repeat(7,minmax(28px,1fr));gap:6px}
label.inline{display:inline-flex;align-items:center;gap:6px;white-space:nowrap}

/* Таблиця */
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 6px 24px rgba(2,6,23,.06)}
thead{background:#f1f5f9;color:#475569;font-size:14px}
th,td{padding:10px 12px;border-top:1px solid var(--br)}
thead th:nth-child(2), thead th:nth-child(3),
tbody td:nth-child(2), tbody td:nth-child(3),
tfoot td:nth-child(2), tfoot td:nth-child(3){text-align:center}
tfoot td{background:#f8fafc;font-weight:600}
.badge{display:inline-block;min-width:28px;padding:2px 8px;text-align:center;border:1px solid var(--br);border-radius:999px;margin-right:8px;font-weight:700;background:#fff}

/* Кнопки */
.btn{appearance:none;border:1px solid var(--br);background:#fff;padding:14px 16px;border-radius:12px;cursor:pointer;font-weight:800;width:100%}
.btn.primary{background:var(--acc);color:#fff;border-color:#0b1220}
.btn:disabled{opacity:.5;cursor:not-allowed}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
@media (max-width:520px){.actions{grid-template-columns:1fr}}

.muted{color:var(--muted)}
.loading{padding:8px 10px;border:1px dashed var(--br);border-radius:10px;background:#fff;margin-top:10px}

/* Модал */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:12px;z-index:100}
.modal{background:#fff;border-radius:16px;max-width:640px;width:100%;padding:14px}
.cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.card{border:1px solid var(--br);border-radius:12px;padding:12px;cursor:pointer;box-shadow:0 2px 10px rgba(2,6,23,.04)}
.card.sel{background:#ecfdf5;border-color:#34d399}
.topbar2{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="logo">NG</div>
    <div class="chip">Генератор оцінки</div>
    <div id="dataState" class="chip">Завантаження…</div>
  </div>

  <!-- Категорія + Стать -->
  <div class="row">
    <fieldset class="tight">
      <legend>Категорія</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="cat" value="2" checked><span>2</span></label>
        <label class="inline"><input type="radio" name="cat" value="3"><span>3</span></label>
      </div>
    </fieldset>
    <fieldset class="tight">
      <legend>Стать</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="sex" value="M" checked><span>М</span></label>
        <label class="inline"><input type="radio" name="sex" value="J"><span>Ж</span></label>
      </div>
    </fieldset>
  </div>

  <!-- Група + Оцінка -->
  <div class="row" style="flex-direction:column">
    <fieldset>
      <legend>Вікова група (1–7)</legend>
      <div class="age-grid" id="ageGrid"></div>
    </fieldset>
    <fieldset style="margin-top:10px">
      <legend>Оцінка</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="grade" value="2"><span>2</span></label>
        <label class="inline"><input type="radio" name="grade" value="3" checked><span>3</span></label>
        <label class="inline"><input type="radio" name="grade" value="4"><span>4</span></label>
        <label class="inline"><input type="radio" name="grade" value="5"><span>5</span></label>
      </div>
    </fieldset>
  </div>

  <!-- Таблиця -->
  <div style="margin-top:12px">
    <table>
      <thead><tr><th>Вправа</th><th>Результат</th><th style="width:120px">Бал</th></tr></thead>
      <tbody id="tbody">
        <tr><td><span class="badge">1</span>Метання медболу</td><td>—</td><td>—</td></tr>
        <tr><td><span class="badge">2/14</span>Підтягування / КСВ</td><td>—</td><td>—</td></tr>
        <tr><td><span class="badge">32б</span>Функц. витривалість</td><td>—</td><td>—</td></tr>
      </tbody>
      <tfoot><tr><td>Сума балів</td><td>—</td><td id="sum">0</td></tr></tfoot>
    </table>

    <div class="actions">
      <button class="btn" id="editBtn">Редагувати</button>
      <button class="btn primary" id="genBtn" disabled>Генерувати</button>
    </div>
  </div>

  <div id="loadBox" class="loading">Дані шкал завантажуються…</div>
</div>

<!-- Модал вибору 3 вправ -->
<div class="modal-back" id="modalBack">
  <div class="modal">
    <div class="topbar2">
      <div style="font-weight:700">Обери 3 вправи</div>
      <button class="btn" id="closeModal">Закрити</button>
    </div>
    <div class="cards" id="cardList"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div id="selCount" class="muted">Обрано: 0/3</div>
      <button class="btn primary" id="applySel" disabled>Готово</button>
    </div>
  </div>
</div>

<script>
/* ====== Версия (cache-bust CSV) ====== */
const VER='r15';

/* ====== Константы/состояние ====== */
const GROUPED='pull_or_ksv';
let category='2', sex='M', ageGroup=2, grade=3;
let picked=['метання медболу', GROUPED, 'функціональна витривалість'];
const state={ thresholds:{M:[],J:[]}, scales:{M:null,J:null}, ready:false };

/* ====== Нормализация имён ====== */
const norm = s => String(s||'').toLowerCase().trim().replace(/[\s\u00A0]+/g,' ');
const NAME_MAP = new Map([
  ['метання медболу','метання медболу'],
  ['підтягування на перекладині','підтягування на перекладині'],
  ['комплексна силова вправа','комплексна силова вправа'],
  ['біг на 100 м','біг на 100 м'],
  ['біг на 1 км','біг на 1 км'],
  ['функціональна витривалість','функціональна витривалість'],
]);
function canonName(s){ const c=NAME_MAP.get(norm(s)); return c||norm(s); }
function labelOf(cn){
  if(cn===GROUPED) return 'Підтягування / КСВ';
  if(cn==='метання медболу') return 'Метання медболу';
  if(cn==='підтягування на перекладині') return 'Підтягування на перекладині';
  if(cn==='комплексна силова вправа') return 'КСВ';
  if(cn==='біг на 100 м') return 'Біг на 100 м';
  if(cn==='біг на 1 км') return 'Біг на 1 км';
  if(cn==='функціональна витривалість') return 'Функц. витривалість';
  return cn;
}

/* ====== Детект разделителя ====== */
function pickDelim(first, allowComma=false){
  if(first.includes('\t')) return '\t';
  if(first.includes(';')) return ';';
  if(first.includes('|')) return '|';
  if(allowComma && first.includes(',')) return ','; // для thresholds можно
  return '\t';
}
async function fetchText(url){ const r=await fetch(url+`?v=${VER}`); if(!r.ok) throw new Error('HTTP '+r.status+' @ '+url); return r.text(); }

/* ====== ШКАЛЫ (scales_*.csv) ====== */
// Поддерживаем:
//  A) [ID, Назва, Одиниця, Бал, Результат] (как в примере с "14 ...")
//  B) [Назва, Одиниця, Бал, Результат] (без ID)
// Запятая НИКОГДА не выступает разделителем (иначе сломает "12,3").
async function loadScales(url){
  const txt=(await fetchText(url)).replace(/^\uFEFF/,'');
  const lines=txt.split(/\r?\n/).filter(x=>x.trim().length);
  if(!lines.length) return {};
  const delim=pickDelim(lines[0], /*allowComma*/ false);
  const rows=lines.map(line=> line.split(delim).map(c=>c.trim()));

  // Определим, есть ли заголовок (ищем слова Назва/Одиниця/Бал/Результат)
  const headerJoin = rows[0].join(' ').toLowerCase();
  const hasHeader = /назва|одиниц|бал|результат/.test(headerJoin);
  const data = hasHeader ? rows.slice(1) : rows;

  const byName={};
  for(const cols of data){
    if(!cols.length) continue;
    let id='', name='', unit='', pts='', res='';

    // Схема A: первая колонка цифры (или "32б") и всего колонок >=5 => трактуем как [ID, Name, Unit, Points, Result]
    const first=cols[0];
    const isID = /^\d+$/.test(first) || /^\d+\s*б$/i.test(first) || /^\d+\s*[a-zа-я]$/i.test(first);
    if(isID && cols.length>=5){
      [id, name, unit, pts, res] = [cols[0], cols[1], cols[2], cols[3], cols[4]];
    }else{
      // Схема B: без ID
      [name, unit, pts, res] = [cols[0]||'', cols[1]||'', cols[2]||'', cols[3]||''];
    }

    const cn = canonName(name);
    const p = parseInt(String(pts||'').replace(/\s/g,''),10);
    if(!cn || !Number.isFinite(p)) continue;
    if(!byName[cn]) byName[cn] = { id: (id||'—'), unit, map:{} };
    byName[cn].map[p] = res;
  }
  return byName;
}

/* ====== ПОРОГИ (thresholds_*.csv) ====== */
async function loadThresholds(url){
  const txt=(await fetchText(url)).replace(/^\uFEFF/,'');
  const lines=txt.split(/\r?\n/).filter(x=>x.trim().length);
  if(!lines.length) return [];
  const delim=pickDelim(lines[0], /*allowComma*/ true);
  const headers = lines[0].split(delim).map(h=>h.trim().toLowerCase());
  const idx = name => headers.indexOf(name);
  const iAge = Math.max(idx('вік'), idx('вікова група'), idx('возрастная группа'), idx('age_group'), idx('група'), idx('группа'));
  const iCat = Math.max(idx('категорія'), idx('категория'), idx('category'));
  const iMin = Math.max(idx('пороговий мінімум'), idx('пороговый минимум'), idx('min_per_exercise'));
  const iS3  = Math.max(idx('із трьох вправ'), idx('з трьох вправ'), idx('из трёх упражнений'), idx('из трех упражнений'), idx('sum_for_grade_3'));
  const iS4  = Math.max(idx('із трьох вправ_4'), idx('з трьох вправ_4'), idx('sum_for_grade_4'));
  const iS5  = Math.max(idx('із трьох вправ_5'), idx('з трьох вправ_5'), idx('sum_for_grade_5'));

  return lines.slice(1).map(line=>{
    const c=line.split(delim).map(x=>x.trim());
    const get=(i)=> (i>=0 && i<c.length)? c[i] : '';
    return {
      age_group: get(iAge),
      category: (get(iCat)||'').replace(/[\s\u00A0]/g,'').replace(/[,;]+/g,','),
      min_per_exercise: get(iMin),
      sum_for_grade_3: get(iS3),
      sum_for_grade_4: get(iS4),
      sum_for_grade_5: get(iS5),
    };
  });
}

/* ====== Загрузка всех CSV ====== */
async function loadAll(){
  const dataState=document.getElementById('dataState');
  try{
    const [thM, thW, scM, scW] = await Promise.all([
      loadThresholds('./data/thresholds_men.csv'),
      loadThresholds('./data/thresholds_women.csv'),
      loadScales('./data/scales_men.csv'),
      loadScales('./data/scales_women.csv'),
    ]);
    state.thresholds.M = thM; state.thresholds.J = thW;
    state.scales.M = scM; state.scales.J = scW;

    const mKeys = Object.keys(scM); const wKeys = Object.keys(scW);
    dataState.textContent = `OK: М[${mKeys.join(', ')||'—'}] Ж[${wKeys.join(', ')||'—'}]`;
    document.getElementById('genBtn').disabled = false;
    document.getElementById('loadBox').classList.add('hidden');
    state.ready = true;
  }catch(e){
    dataState.textContent='Помилка завантаження';
    document.getElementById('loadBox').textContent='Помилка CSV: '+e.message;
    console.error(e);
  }
}

/* ====== UI ====== */
const ageGrid=document.getElementById('ageGrid');
for(let g=1;g<=7;g++){
  const lab=document.createElement('label'); lab.className='inline';
  const inp=document.createElement('input'); inp.type='checkbox'; inp.checked=(g===ageGroup);
  inp.addEventListener('change',()=>{ageGroup=g;[...ageGrid.querySelectorAll('input')].forEach((el,idx)=>el.checked=(idx+1)===g);});
  lab.appendChild(inp); lab.appendChild(document.createTextNode(' '+g)); ageGrid.appendChild(lab);
}
document.querySelectorAll('input[name="cat"]').forEach(r=>r.addEventListener('change',e=>{category=e.target.value;}));
document.querySelectorAll('input[name="sex"]').forEach(r=>r.addEventListener('change',e=>{sex=e.target.value;}));
document.querySelectorAll('input[name="grade"]').forEach(r=>r.addEventListener('change',e=>{grade=parseInt(e.target.value,10);}));      

const tbody=document.getElementById('tbody'); const sumEl=document.getElementById('sum');
function renderRows(rows){
  tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><span class="badge">${r.badge||'—'}</span>${labelOf(r.name)}</td><td>${r.result}</td><td>${r.points}</td>`;
    tbody.appendChild(tr);
  });
  const total=rows.reduce((a,r)=>a+(isFinite(+r.points)?+r.points:0),0);
  sumEl.textContent=total;
}
function renderPicked(){
  const scales = (sex==='M'?state.scales.M:state.scales.J) || {};
  const rows = picked.map(n=>{
    if(n===GROUPED) return {name:GROUPED,result:'—',points:'—',badge:'2/14'};
    const cn=canonName(n);
    const badge = (scales[cn] && scales[cn].id) ? String(scales[cn].id) : '—';
    return {name:cn,result:'—',points:'—',badge};
  });
  renderRows(rows);
}
renderPicked();

/* ====== Модал выбора 3-х вправ ====== */
const modalBack=document.getElementById('modalBack');
const editBtn=document.getElementById('editBtn');
const closeModal=document.getElementById('closeModal');
const applySel=document.getElementById('applySel');
const cardList=document.getElementById('cardList');
const selCount=document.getElementById('selCount');

function buildCards(){
  const CHOICES=['метання медболу', GROUPED, 'біг на 100 м', 'біг на 1 км', 'функціональна витривалість'];
  cardList.innerHTML='';
  let temp=[...picked];
  CHOICES.forEach(name=>{
    const div=document.createElement('div');
    div.className='card'+(temp.includes(name)?' sel':'');
    div.textContent = (name===GROUPED) ? 'Підтягування / КСВ' : `${labelOf(name)}`;
    div.addEventListener('click',()=>{
      const i=temp.indexOf(name);
      if(i>=0) temp.splice(i,1); else { if(temp.length>=3) return; temp.push(name); }
      picked=[...temp]; buildCards();
    });
    cardList.appendChild(div);
  });
  selCount.textContent=`Обрано: ${picked.length}/3`;
  applySel.disabled=(picked.length!==3);
}
editBtn.addEventListener('click',()=>{buildCards(); modalBack.style.display='flex';});
closeModal.addEventListener('click',()=>{modalBack.style.display='none';});
applySel.addEventListener('click',()=>{ if(picked.length!==3) return; renderPicked(); modalBack.style.display='none';});

/* ====== Генерация ====== */
function onlyNumber(s){ const m=String(s||'').match(/(\d+)/); return m?parseInt(m[1],10):0 }
function randint(a,b){return Math.floor(a+Math.random()*(b-a+1))}

function activeThreshold(){
  const list=(sex==='M'?state.thresholds.M:state.thresholds.J);
  if(!list || !list.length) return null;
  const need=(category==='3'?'3,4':'2');
  let best=null,bestDiff=1e9;

  for(const r of list){
    const cat=(String(r.category||'').replace(/[\s\u00A0]/g,'').replace(/[,;]+/g,','))||'';
    if(cat!==need) continue;
    const g=parseInt(r.age_group,10); if(!Number.isFinite(g)) continue;
    const d=Math.abs(g-ageGroup);
    if(d<bestDiff){best=r;bestDiff=d;}
  }
  if(!best){
    for(const r of list){
      const g=parseInt(r.age_group,10); if(!Number.isFinite(g)) continue;
      const d=Math.abs(g-ageGroup);
      if(d<bestDiff){best=r;bestDiff=d;}
    }
  }
  return best;
}

function getScales(){ return sex==='M' ? state.scales.M : state.scales.J }

function generate(){
  if(!state.ready){ alert('Дані ще не завантажені'); return; }
  let th=activeThreshold();
  if(!th){
    th={min_per_exercise:'10',sum_for_grade_3:'60',sum_for_grade_4:'80',sum_for_grade_5:'95'};
    document.getElementById('dataState').textContent='Fallback пороги (перевір CSV)';
  }
  const minPer=onlyNumber(th.min_per_exercise);
  const s5=onlyNumber(th.sum_for_grade_5), s4=onlyNumber(th.sum_for_grade_4), s3=onlyNumber(th.sum_for_grade_3);
  let minSum,nextSum;
  if(grade===5){minSum=s5;nextSum=null}
  else if(grade===4){minSum=s4;nextSum=s5}
  else if(grade===3){minSum=s3;nextSum=s4}
  else {minSum=3*minPer; nextSum=s3? s3:(minSum+15)}

  let target;
  if(!nextSum){ target=minSum; }
  else{
    const x=Math.max(1,nextSum-minSum); const r=Math.random();
    let lo=minSum, hi=minSum+Math.floor(0.3*x);
    if(r>=0.8 && r<0.95){ lo=minSum+Math.floor(0.3*x); hi=minSum+Math.floor(0.5*x); }
    else if(r>=0.95){ lo=minSum+Math.floor(0.5*x); hi=minSum+Math.floor(0.7*x); }
    if(hi>=nextSum) hi=nextSum-1; if(hi<lo) hi=lo; target=randint(lo,hi);
  }

  const scales=getScales()||{};
  let names=[...picked];
  if(names.includes(GROUPED)){
    const hasPull = !!scales[canonName('підтягування на перекладині')];
    const hasKsv  = !!scales[canonName('комплексна силова вправа')];
    let chosen=null;
    if (sex==='J') { chosen = hasKsv ? 'комплексна силова вправа' : (hasPull?'підтягування на перекладині':null); }
    else { chosen = (Math.random()<0.8) ? (hasPull?'підтягування на перекладині':(hasKsv?'комплексна силова вправа':null))
                                        : (hasKsv?'комплексна силова вправа':(hasPull?'підтягування на перекладині':null)); }
    if(!chosen){ alert('Немає шкали для Підтягування/КСВ'); return; }
    names = names.map(n=> n===GROUPED ? chosen : n);
  }

  const cnames = names.map(canonName);
  for(const n of cnames){ if(!scales[n]){ alert('Немає шкали для '+labelOf(n)); return; } }

  const allowed = cnames.map(n => Object.keys(scales[n].map).map(x=>parseInt(x,10)).filter(v=>v>=minPer).sort((a,b)=>b-a));
  const mean=target/3; const devMax=(Math.random()<0.8?0.30:0.40)*mean; const lo=Math.max(minPer,Math.floor(mean-devMax)); const hi=Math.ceil(mean+devMax);
  const resFor = (n,pts) => { const v=scales[n].map[pts]; return (v && v!=='-' && v!=='—') ? v : null; };

  let solution=null;
  outer: for(let t=0;t<15000;t++){
    const c1=allowed[0].filter(v=>v>=lo&&v<=hi); const c2=allowed[1].filter(v=>v>=lo&&v<=hi);
    if(!c1.length||!c2.length) break;
    const v1=c1[Math.floor(Math.random()*c1.length)];
    const v2=c2[Math.floor(Math.random()*c2.length)];
    const v3=target-v1-v2; if(v3<lo||v3>hi) continue; if(!allowed[2].includes(v3)) continue;
    const r1=resFor(cnames[0],v1), r2=resFor(cnames[1],v2), r3=resFor(cnames[2],v3);
    if(!r1||!r2||!r3) continue;
    solution=[
      {name:cnames[0], points:v1, result:r1, badge:(scales[cnames[0]].id||'—')},
      {name:cnames[1], points:v2, result:r2, badge:(scales[cnames[1]].id||'—')},
      {name:cnames[2], points:v3, result:r3, badge:(scales[cnames[2]].id||'—')},
    ];
    break outer;
  }
  if(!solution){ alert('Не вдалося підібрати бали під умови. Перевір шкали/пороги.'); return; }
  renderRows(solution);
}

/* ====== События ====== */
document.getElementById('genBtn').addEventListener('click',generate);
document.getElementById('editBtn').addEventListener('click',()=>{}); // логика в buildCards

// init
if('serviceWorker' in navigator){
window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js',{scope:'./'}).catch(console.error); });
}
loadAll();
</script>
</body>
</html>
