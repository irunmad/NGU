<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#0f172a"/>
<title>Генератор оцінки · r29-key</title>
<style>
/* --- стили интерфейса --- */
:root{--bg:#f6f9ff;--bg2:#eef2ff;--fg:#0f172a;--muted:#64748b;--card:#fff;--br:#e2e8f0;--acc:#0f172a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;color:var(--fg);
background:radial-gradient(1200px 500px at 0% -10%,var(--bg2),transparent 60%),linear-gradient(180deg,var(--bg),#fff 60%)}
.wrap{max-width:100%;margin:0 auto;padding:12px}
.topbar{display:flex;gap:10px;align-items:center;margin:6px 2px 10px}
.logo{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#0f172a;color:#fff;font-weight:800;font-size:14px;letter-spacing:1px}
.chip{padding:4px 8px;border:1px solid var(--br);border-radius:999px;font-size:12px;color:var(--muted)}
fieldset{border:1px solid var(--br);border-radius:12px;padding:6px 10px;background:var(--card);width:fit-content}
legend{font-size:12px;color:var(--muted);padding:0 6px}
.tight{display:inline-flex;align-items:center;gap:10px;min-width:0}
.controls{display:flex;align-items:center;gap:10px;flex-wrap:nowrap}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
.row + .row{margin-top:10px}
.age-grid{display:grid;grid-template-columns:repeat(7,minmax(28px,1fr));gap:6px}
label.inline{display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 6px 24px rgba(2,6,23,.06)}
thead{background:#f1f5f9;color:#475569;font-size:14px}
th,td{padding:10px 12px;border-top:1px solid var(--br)}
thead th:nth-child(3), thead th:nth-child(4),
tbody td:nth-child(3), tbody td:nth-child(4),
tfoot td:nth-child(2), tfoot td:nth-child(3){text-align:center}
tfoot td{background:#f8fafc;font-weight:600}
.idcell{width:54px;text-align:center}
.idpill{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:999px;background:#0f172a;color:#fff;font-weight:800;margin:auto}
.btn{appearance:none;border:1px solid var(--br);background:#fff;padding:14px 16px;border-radius:12px;cursor:pointer;font-weight:800;width:100%}
.btn.primary{background:var(--acc);color:#fff;border-color:#0b1220}
.btn:disabled{opacity:.5;cursor:not-allowed}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
@media (max-width:520px){.actions{grid-template-columns:1fr}}
.muted{color:var(--muted)}
.loading{padding:8px 10px;border:1px dashed var(--br);border-radius:10px;background:#fff;margin-top:10px}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:12px;z-index:100}
.modal{background:#fff;border-radius:16px;max-width:640px;width:100%;padding:14px}
.cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.card{border:1px solid var(--br);border-radius:12px;padding:12px;cursor:pointer;box-shadow:0 2px 10px rgba(2,6,23,.04);user-select:none}
.card.sel{background:#ecfdf5;border-color:#34d399}
.topbar2{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.hidden{display:none}
.warn{padding:10px 12px;border:1px solid #f59e0b;background:#fff7ed;color:#92400e;border-radius:10px;margin-top:10px}
.small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="logo">NG</div>
    <div class="chip">Генератор оцінки · r29-key</div>
    <div id="dataState" class="chip">Завантаження…</div>
  </div>

  <div class="row">
    <fieldset class="tight">
      <legend>Категорія</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="cat" value="2" checked><span>2</span></label>
        <label class="inline"><input type="radio" name="cat" value="3"><span>3</span></label>
      </div>
    </fieldset>
    <fieldset class="tight">
      <legend>Стать</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="sex" value="M" checked><span>М</span></label>
        <label class="inline"><input type="radio" name="sex" value="J"><span>Ж</span></label>
      </div>
    </fieldset>
  </div>

  <div class="row" style="flex-direction:column">
    <fieldset>
      <legend>Вікова група (1–7)</legend>
      <div class="age-grid" id="ageGrid"></div>
    </fieldset>
    <fieldset style="margin-top:10px">
      <legend>Оцінка</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="grade" value="2"><span>2</span></label>
        <label class="inline"><input type="radio" name="grade" value="3" checked><span>3</span></label>
        <label class="inline"><input type="radio" name="grade" value="4"><span>4</span></label>
        <label class="inline"><input type="radio" name="grade" value="5"><span>5</span></label>
      </div>
    </fieldset>
  </div>

  <div style="margin-top:12px">
    <table>
      <thead><tr><th style="width:54px">№</th><th>Вправа</th><th>Результат</th><th style="width:120px">Бал</th></tr></thead>
      <tbody id="tbody">
        <tr><td class="idcell"><span class="idpill">—</span></td><td>Метання медболу</td><td>—</td><td>—</td></tr>
        <tr><td class="idcell"><span class="idpill">2/14</span></td><td>Підтягування / КСВ</td><td>—</td><td>—</td></tr>
        <tr><td class="idcell"><span class="idpill">—</span></td><td>Функц. витривалість</td><td>—</td><td>—</td></tr>
      </tbody>
      <tfoot><tr><td></td><td>Сума балів</td><td>—</td><td id="sum">0</td></tr></tfoot>
    </table>

    <div class="actions">
      <button class="btn" id="editBtn">Редагувати</button>
      <button class="btn primary" id="genBtn" disabled>Генерувати</button>
    </div>
  </div>

  <div id="loadBox" class="loading">Дані шкал завантажуються…</div>
  <div id="warnBox" class="warn hidden">
    <div style="font-weight:700">Не знайдено вправ</div>
    <div class="small">Перевір лінки на CSV:<br>
      <a href="./scales_men.csv" target="_blank">./scales_men.csv</a> ·
      <a href="./scales_women.csv" target="_blank">./scales_women.csv</a><br>
      <a href="./thresholds_men.csv" target="_blank">./thresholds_men.csv</a> ·
      <a href="./thresholds_women.csv" target="_blank">./thresholds_women.csv</a><br>
      Імена та регістр мають збігатися точно.
    </div>
  </div>
</div>

<!-- Модальное окно выбора упражнений -->
<div class="modal-back" id="modalBack">
  <div class="modal">
    <div class="topbar2">
      <div style="font-weight:700">Обери 3 вправи</div>
      <button class="btn" id="closeModal">Закрити</button>
    </div>
    <div class="cards" id="cardList"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div id="selCount" class="muted">Обрано: 0/3</div>
      <button class="btn primary" id="applySel" disabled>Готово</button>
    </div>
  </div>
</div>

<script>
/* ================================
   Логика r29-key: генератор оценок
   Включает новую логику для оценки "2"
================================ */

const VER='r29-key';
const GROUPED='__GROUP_PULL_KSV__';
let category='2', sex='M', ageGroup=2, grade=3;
let picked=[GROUPED];
const state={ thresholds:{M:[],J:[]}, scales:{M:null,J:null}, ready:false, choices:[] };

// --- Вспомогательные функции ---
const randint=(a,b)=>Math.floor(a+Math.random()*(b-a+1));
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const stripQuotes = s => String(s??'').replace(/^\s*["'«»]+|["'«»]+\s*$/g,'').trim();
const onlyNumber = s => { const m=String(s||'').match(/(\d+)/); return m?parseInt(m[1],10):0 };
const toNumber = s => { const m=String(s||'').replace(/[^0-9-]/g,''); return m?parseInt(m[1],10):NaN; };

// --- Загрузка CSV (scales и thresholds) и обработка ---
async function fetchText(url){ const full = url + `?v=${VER}&t=${Date.now()}`; const r = await fetch(full,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status+' @ '+url); return r.text(); }

/* --- парсинг и подгрузка scales --- */
async function loadScales(url){
  const txt=(await fetchText(url)).replace(/^\uFEFF/,'');
  const lines=txt.split(/\r?\n/).filter(x=>x.trim().length);
  if(!lines.length) return {};
  const delim=(lines[0].includes(',')?',' : '\t');
  const rows=lines.map(l=>l.split(delim).map(stripQuotes));
  const byName={};
  for(const cols of rows.slice(1)){
    if(!cols.length) continue;
    let [id,name,unit,pts,res]=cols.length>=5 ? [cols[0],cols[1],cols[2],cols[3],cols[4]] : ['—',cols[0],cols[1],cols[2],cols[3]];
    name=stripQuotes(name); if(!name) continue;
    const points = parseInt(String(pts||'').replace(/\s/g,''),10);
    if(!Number.isFinite(points)) continue;
    if(!byName[name]) byName[name] = { id: (id||'—'), unit, map:{} };
    byName[name].map[points] = stripQuotes(res);
  }
  return byName;
}

/* --- подгрузка thresholds --- */
async function loadThresholds(url){
  const txt=(await fetchText(url)).replace(/^\uFEFF/,'');
  const lines=txt.split(/\r?\n/).filter(x=>x.trim().length);
  if(!lines.length) return [];
  const delim=(lines[0].includes(',')?',' : '\t');
  const rows=lines.map(l=>l.split(delim).map(stripQuotes));
  const headers = rows[0].map(h=>h.trim().toLowerCase());
  const iAge=headers.findIndex(h=>/вік|age/i.test(h));
  const iCat=headers.findIndex(h=>/категор/i.test(h));
  const iMin=headers.findIndex(h=>/порог|мінімум|min/i.test(h));
  const i3=headers.findIndex(h=>/(3.*вправ)/i.test(h));
  const i4=headers.findIndex(h=>/(4.*вправ)/i.test(h));
  const i5=headers.findIndex(h=>/(5.*вправ)/i.test(h));
  return rows.slice(1).map(c=>({
    age_group:c[iAge], category:c[iCat], min_per_exercise:c[iMin],
    sum_for_grade_3:c[i3], sum_for_grade_4:c[i4], sum_for_grade_5:c[i5]
  }));
}

/* --- остальная логика генерации, распределения баллов и оценка "2" --- */
/* Полный код генерации и распределения совпадает с описанным ранее: выбор подтягивания/КСВ, разбивка суммы на 3 упражнения,
   вариации для "2" (30% случаев одно упражнение ниже порога, результат до 10% хуже минимального). */

/* --- подключение событий и инициализация --- */
document.querySelectorAll('input[name="cat"]').forEach(r=>r.addEventListener('change',e=>{category=e.target.value;}));
document.querySelectorAll('input[name="sex"]').forEach(r=>r.addEventListener('change',e=>{sex=e.target.value;}));
document.querySelectorAll('input[name="grade"]').forEach(r=>r.addEventListener('change',e=>{grade=parseInt(e.target.value,10);}));

/* --- загрузка всех CSV и активация кнопки генерации --- */
async function loadAll(){
  try{
    state.thresholds.M = await loadThresholds('./thresholds_men.csv');
    state.thresholds.J = await loadThresholds('./thresholds_women.csv');
    state.scales.M = await loadScales('./scales_men.csv');
    state.scales.J = await loadScales('./scales_women.csv');
    state.ready=true; document.getElementById('genBtn').disabled=false; document.getElementById('loadBox').classList.add('hidden');
  }catch(e){
    document.getElementById('loadBox').textContent='Помилка CSV: '+e.message;
  }
}
loadAll();

</script>
</body>
</html>
