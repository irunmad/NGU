<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#0f172a"/>
<link rel="manifest" href="manifest.webmanifest"/>
<title>Генератор</title>
<style>
:root{--bg:#f6f9ff;--bg2:#eef2ff;--fg:#0f172a;--muted:#64748b;--card:#fff;--br:#e2e8f0;--acc:#0f172a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;color:var(--fg);
background:radial-gradient(1200px 500px at 0% -10%,var(--bg2),transparent 60%),linear-gradient(180deg,var(--bg),#fff 60%)}
.wrap{max-width:100%;margin:0 auto;padding:12px}
.topbar{display:flex;gap:10px;align-items:center;margin:6px 2px 10px}
.logo{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#0f172a;color:#fff;font-weight:800;font-size:14px;letter-spacing:1px}
.chip{padding:4px 8px;border:1px solid var(--br);border-radius:999px;font-size:12px;color:#64748b}
fieldset{border:1px solid var(--br);border-radius:12px;padding:6px 10px;background:var(--card);width:fit-content}
legend{font-size:12px;color:#64748b;padding:0 6px}
.tight{display:inline-flex;align-items:center;gap:10px;min-width:0}
.controls{display:flex;align-items:center;gap:10px;flex-wrap:nowrap}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
.row + .row{margin-top:10px}
.age-grid{display:grid;grid-template-columns:repeat(7,minmax(28px,1fr));gap:6px}
label.inline{display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 6px 24px rgba(2,6,23,.06)}
thead{background:#f1f5f9;color:#475569;font-size:14px}
th,td{padding:10px 12px;border-top:1px solid var(--br)}
thead th:nth-child(3), thead th:nth-child(4),
tbody td:nth-child(3), tbody td:nth-child(4),
tfoot td:nth-child(2), tfoot td:nth-child(3){text-align:center}
tfoot td{background:#f8fafc;font-weight:600}
.idcell{width:54px;text-align:center}
.idpill{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:999px;background:#0f172a;color:#fff;font-weight:800;margin:auto}
.btn{appearance:none;border:1px solid var(--br);background:#fff;padding:14px 16px;border-radius:12px;cursor:pointer;font-weight:800;width:100%}
.btn.primary{background:var(--acc);color:#fff;border-color:#0b1220}
.btn:disabled{opacity:.5;cursor:not-allowed}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
@media (max-width:520px){.actions{grid-template-columns:1fr}}
.muted{color:#64748b}
.loading{padding:8px 10px;border:1px dashed var(--br);border-radius:10px;background:#fff;margin-top:10px}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:12px;z-index:100}
.modal{background:#fff;border-radius:16px;max-width:640px;width:100%;padding:14px}
.cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.card{border:1px solid var(--br);border-radius:12px;padding:12px;cursor:pointer;box-shadow:0 2px 10px rgba(2,6,23,.04);user-select:none}
.card.sel{background:#ecfdf5;border-color:#34d399}
.topbar2{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="logo">NG</div>
    <div class="chip">Генератор оцінки · r35</div>
    <div id="dataState" class="chip">Завантаження…</div>
  </div>

  <div class="row">
    <fieldset class="tight">
      <legend>Категорія</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="cat" value="2" checked><span>2</span></label>
        <label class="inline"><input type="radio" name="cat" value="3"><span>3</span></label>
      </div>
    </fieldset>
    <fieldset class="tight">
      <legend>Стать</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="sex" value="M" checked><span>М</span></label>
        <label class="inline"><input type="radio" name="sex" value="J"><span>Ж</span></label>
      </div>
    </fieldset>
  </div>

  <div class="row" style="flex-direction:column">
    <fieldset>
      <legend>Вікова група (1–7)</legend>
      <div class="age-grid" id="ageGrid"></div>
    </fieldset>
    <fieldset style="margin-top:10px">
      <legend>Оцінка</legend>
      <div class="controls">
        <label class="inline"><input type="radio" name="grade" value="2"><span>2</span></label>
        <label class="inline"><input type="radio" name="grade" value="3" checked><span>3</span></label>
        <label class="inline"><input type="radio" name="grade" value="4"><span>4</span></label>
        <label class="inline"><input type="radio" name="grade" value="5"><span>5</span></label>
      </div>
    </fieldset>
  </div>

  <div style="margin-top:12px">
    <table>
      <thead><tr><th style="width:54px">№</th><th>Вправа</th><th>Результат</th><th style="width:120px">Бал</th></tr></thead>
      <tbody id="tbody">
        <tr><td class="idcell"><span class="idpill">—</span></td><td>Метання медболу</td><td>—</td><td>—</td></tr>
        <tr><td class="idcell"><span class="idpill">2/14</span></td><td>Підтягування / КСВ</td><td>—</td><td>—</td></tr>
        <tr><td class="idcell"><span class="idpill">—</span></td><td>Функц. витривалість</td><td>—</td><td>—</td></tr>
      </tbody>
      <tfoot><tr><td></td><td>Сума балів</td><td>—</td><td id="sum">0</td></tr></tfoot>
    </table>

    <div class="actions">
      <button class="btn" id="editBtn">Редагувати</button>
      <button class="btn primary" id="genBtn" disabled>Генерувати</button>
    </div>
  </div>

  <div id="loadBox" class="loading">Дані шкал завантажуються…</div>
</div>

<div class="modal-back" id="modalBack">
  <div class="modal">
    <div class="topbar2">
      <div style="font-weight:700">Обери 3 вправи</div>
      <button class="btn" id="closeModal">Закрити</button>
    </div>
    <div class="cards" id="cardList"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div id="selCount" class="muted">Обрано: 0/3</div>
      <button class="btn primary" id="applySel" disabled>Готово</button>
    </div>
  </div>
</div>

<script>
const VER='r35';
const GROUPED='__GROUP_PULL_KSV__';
let category='2', sex='M', ageGroup=2, grade=3;
let picked=[GROUPED];
const state={ thresholds:{M:[],J:[]}, scales:{M:null,J:null}, ready:false, choices:[] };

const strip = s => String(s??'').trim();
const stripQuotes = s => String(s??'').replace(/^\s*["'«»]+|["'«»]+\s*$/g,'').trim();
const onlyInt = s => { const m=String(s||'').match(/(\d+)/); return m?parseInt(m[1],10):0 };
const asComma = (x,d)=>x.toFixed(d).replace('.',',');

function pickDelim(line){
  if(line.includes('\t')) return '\t';
  if(line.includes(';')) return ';';
  if(line.includes('|')) return '|';
  if(line.includes(',')) return ',';
  return '\t';
}
function parseCSVLine(line, delim){
  if(delim=='\t') delim='\t'.replace('\\t','\t');
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
    else if(ch===delim && !q){ out.push(cur); cur=''; }
    else { cur+=ch; }
  }
  out.push(cur);
  return out.map(c=>stripQuotes(c));
}
async function fetchText(url){ const r=await fetch(url+`?v=${VER}&t=${Date.now()}`,{cache:'no-store'}); if(!r.ok) throw new Error(url+': '+r.status); return r.text(); }

/* === SCALES by exercise name === */
async function loadScales(url){
  const txt=(await fetchText(url)).replace(/^\uFEFF/,'');
  const lines=txt.split(/\r?\n/).filter(x=>x.trim().length);
  if(!lines.length) return {};
  const delim=pickDelim(lines[0]);
  const rows=lines.map(l=>parseCSVLine(l,delim));
  const H = Object.fromEntries(rows[0].map((h,i)=>[h,i]));
  /* placeholder */